<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="username" th:content="${username}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link rel="icon" th:href="@{/images/favicon.png}" />
    <title>Control Rule</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            display: flex;
            margin: 0;
            min-height: 100vh;
            background-color: #f5f5f5;
        }

        .sidebar {
            width: 20vw;
            min-height: 100vh;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            transition: width 0.3s ease;
            position: relative;
        }

        .sidebar.collapsed {
            width: 5vw;
        }

        .sidebar.collapsed .name {
            display: none;
        }

        .sidebar.collapsed .profile-icon {
            display: flex;
            justify-content: center;
            margin: 10px 0;
        }

        .sidebar.collapsed .profile-icon img {
            width: 3vw;
            height: 3vw;
            margin-bottom: 10px;
        }

        .sidebar.collapsed .menu-btn p,
        .sidebar.collapsed .gear-icon p,
        .sidebar.collapsed .power-icon p {
            display: none;
        }

        .sidebar.collapsed .menu-btn,
        .sidebar.collapsed .gear-icon,
        .sidebar.collapsed .power-icon {
            justify-content: center;
            padding: 12px 0;
        }

        .sidebar.collapsed .menu-btn img,
        .sidebar.collapsed .gear-icon img,
        .sidebar.collapsed .power-icon img {
            margin: 0;
        }

        .main-content {
            flex: 1;
            padding-left: 20px;
            transition: padding-left 0.3s ease;
        }

        /* Toggle button */
        .toggle-btn {
            position: absolute;
            right: -15px;
            top: 50%;
            width: 30px;
            height: 30px;
            background: #2c3e50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1;
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed .toggle-btn {
            transform: rotate(180deg);
        }

        .profile-icon img {
            width: 10vw;
            margin-bottom: 20px;
            border-radius: 50%;
            border: 3px solid #fff;
            transition: transform 0.3s ease;
        }

        .profile-icon img:hover {
            transform: scale(1.05);
        }

        .name {
            margin: 30px 60px;
            font-weight: bold;
            font-size: 150%;
            text-transform: uppercase;
        }

        /* menu */
        .menu {
            display: flex;
            flex-direction: column;
            width: 100%;
            flex-grow: 1;
            gap: 12px;
            padding: 20px 15px;
        }

        .menu-btn {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .gear-icon:hover,
        .power-icon:hover {
            background: rgba(85, 113, 139, 0.5);
            transform: translateY(-2px);
        }

        .menu-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .menu-btn.active {
            background: rgba(255, 255, 255, 0.2);
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .power-button:hover {
            background: rgba(85, 113, 139, 0.5);
        }

        .settings {
            width: 100%;
            margin-top: auto;
            padding-bottom: 15px;
        }

        .gear-icon,
        .power-icon {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            gap: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
            border-radius: 8px;
            margin: 5px 0;
            background: none;
            border: none;
            width: 100%;
        }

        .menu-btn img {
            width: 32px;
        }

        .menu-btn p {
            color: white;
            font-size: 16px;
            font-weight: 500;
            margin: 0;
        }

        .menu-btn:hover {
            background: rgba(85, 113, 139, 0.5);
            transform: translateY(-2px);
        }

        .menu-btn:hover img {
            transform: none;
        }

        .gear-icon img {
            width: 24px;
            height: 24px;
            transition: transform 0.3s ease;
        }

        .gear-icon:hover img {
            transform: rotate(30deg);
        }

        .gear-icon p {
            color: white;
            font-size: 16px;
            font-weight: 500;
            margin: 0;
        }

        .setting-icon,
        .logout-icon {
            width: 24px;
            height: 24px;
        }

        .computer {
            width: 15vw;
            height: 42vh;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
        }

        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #e74c3c;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            z-index: 10;
        }

        .delete-btn:hover {
            transform: scale(1.1);
            background-color: #c0392b;
        }

        .computer .pc-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            text-align: center;
        }

        .computer .status {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }

        .computer .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #34495e;
            padding: 5px 10px;
            border-radius: 8px;
            background-color: #f8f9fa;
        }

        .status-item.connected {
            color: #27ae60;
        }

        .status-item.active {
            color: #2980b9;
        }

        .computer:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .computer img {
            width: 50%;
            margin-top: 10px;
            transition: transform 0.2s ease-in-out;
        }

        .computer img:hover {
            transform: scale(1.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        /* CSS cho container chứa các nút */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-top: 10%;
            gap: 8px;
        }

        /* CSS chung cho tất cả các nút */
        .action-buttons button,
        .action-buttons a {
            border: none;
            color: white;
            text-decoration: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            font-size: 0.9em;
            height: 40px;
            width: 40px;
            border-radius: 50%;
            padding: 0;
        }

        /* CSS cho nút chi tiết (màu xanh lá) */
        .details-btn {
            background: linear-gradient(to right, #2ecc71, #27ae60);
            width: 40px;
            padding: 0;
            border-radius: 50%;
        }

        /* CSS cho nút tắt máy (màu đỏ) */
        .shutdown-btn {
            background: linear-gradient(to right, #e74c3c, #c0392b);
            width: 40px;
            padding: 0;
            border-radius: 50%;
        }

        /* CSS cho nút check status (màu xanh dương) */
        .check-status-btn {
            background: linear-gradient(to right, #3498db, #2980b9);
            position: relative;
            overflow: hidden;
        }

        /* CSS cho icon trong nút */
        .details-btn i,
        .shutdown-btn i,
        .check-status-btn i {
            font-size: 1.2em;
        }

        /* CSS cho hiệu ứng hover */
        .details-btn:hover,
        .shutdown-btn:hover,
        .check-status-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* CSS cho trạng thái loading */
        .check-status-btn.loading {
            background: linear-gradient(to right, #3498db, #2980b9);
        }

        /* CSS cho hiệu ứng loading dots */
        .loading-dots {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .loading-dots span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: white;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
                opacity: 0.5;
            }

            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Xóa margin-top trùng lặp */
        .check-status-btn {
            margin-top: 0;
        }

        /* CSS cho icon quay trong nút checking */
        .fa-sync-alt {
            animation: spin 1.5s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .menu {
            display: flex;
            flex-direction: column;
            width: 100%;
            flex-grow: 1;
        }

        /* ======== BEAUTIFUL DETAIL-MODAL ======== */
        .detail-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(3px);
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .detail-modal.show {
            display: flex;
        }

        .detail-modal .modal-content {
            display: flex;
            flex-direction: column;
            ;
            background: #fff;
            width: 90%;
            max-width: 500px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.2);
            animation: popIn 0.25s ease-out;
        }

        @keyframes popIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* HEADER */
        .detail-modal .modal-content .modal-header {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            background: linear-gradient(135deg, #4a6572, #1f2f38);
            color: #fff;
        }

        .detail-modal .modal-content .modal-header h3 {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .detail-modal .modal-content .modal-header .close-modal {
            font-size: 22px;
            cursor: pointer;
            transition: color .2s;
        }

        .detail-modal .modal-content .modal-header .close-modal:hover {
            color: #ddd;
        }

        /* BODY */
        .detail-modal .modal-content .modal-body {
            padding: 20px 24px;
        }

        .detail-modal .modal-content .modal-body table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .detail-modal .modal-content .modal-body td {
            padding: 8px 0;
            vertical-align: top;
        }

        .detail-modal .modal-content .modal-body td:first-child {
            font-weight: 600;
            color: #2c3e50;
            width: 40%;
        }

        .detail-modal .modal-content .modal-body td+td {
            color: #555;
        }

        /* FOOTER */
        .detail-modal .modal-content .modal-footer {
            padding: 12px 24px;
            text-align: right;
        }

        .detail-modal .modal-content .modal-footer .close-detail-modal {
            background: #1f2f38;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background .2s;
        }

        .detail-modal .modal-content .modal-footer .close-detail-modal:hover {
            background: #4a6572;
        }

        .detail-item{
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
        }
        .off{
            cursor: pointer;
            padding: 3px;
            font-size: 25px;
        }


        /* Add these styles for the add computer button and modal */
        .add-computer {
            width: 15vw;
            height: 42vh;
            border: 2px dashed #4A4A4A;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #4A4A4A;
            cursor: pointer;
            border-radius: 10px;
        }

        .btn_add_computer {
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 24px;
            margin: 20px 0;
            width: 40%;
            background: linear-gradient(45deg, #28A745, #34ce57);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .btn_add_computer:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        /* Content area */
        #content-area {
            width: 100%;
            margin: 2%;
            transition: opacity 0.2s ease;
        }

        .section {
            display: flex;
            height: 100%;
            flex-wrap: wrap;
            gap: 50px;
        }

        .section-title {
            font-size: 28px;
            color: #2c3e50;
            text-align: center;
            margin: 15px 0;
            font-weight: bold;
            text-transform: uppercase;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 30px;
            display: flex;
            width: 60%;
            height: 80%;
        }

        .modal-left {
            flex: 1;
            padding: 20px;
        }

        .modal-right {
            width: 45%;
            background-color: #FF8400;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 25px;
            font-weight: bold;
            border-radius: 0 30px 30px 0;
            position: relative;
        }

        .modal-right img {
            position: absolute;
            top: 20px;
            right: 20px;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }

        .modal-right img:hover {
            transform: scale(1.2);
        }

        .input-contain {
            position: relative;
            margin: 10px 0;
            width: 80%;
        }

        .input-field {
            width: 100%;
            font-size: 16px;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            outline: none;
        }

        .input-field:focus {
            border-color: #0e51ff;
        }

        .eye-icon {
            position: absolute;
            right: 5%;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #a6a6a6;
        }

        label {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            transition: all 0.3s ease;
            pointer-events: none;
            color: #999;
            font-size: 16px;
            background: white;
            padding: 0 5px;
        }

        .input-field:focus+label,
        .input-field.has-content+label {
            top: 0;
            font-size: 12px;
            color: #0e51ff;
            transform: translateY(-50%);
        }

        form {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            justify-content: center;
        }

        /* Information section styles */
        .info-container {
            display: flex;
            justify-content: center;
            width: 100%;
            margin: 30px 0;
        }

        .info-content,
        .info-form {
            background: #ffffff;
            padding: 15px 40px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            width: 50%;
            max-width: 800px;
            margin: 0 auto;
        }

        .info-content {
            border-left: 5px solid #3498db;
        }

        .info-form {
            border-left: 5px solid #e67e22;
        }

        .info-content p,
        .info-form p {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 20px;
            margin: 20px 0;
            align-items: center;
        }

        .info-content strong,
        .info-form strong {
            color: #2c3e50;
            font-weight: 600;
            font-size: 18px;
        }

        .info-content span {
            color: #34495e;
            font-size: 18px;
            word-break: break-word;
        }

        .info-form input {
            padding: 12px 15px;
            font-size: 18px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.3s ease;
            width: 95%;
        }

        .info-form input:focus {
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }

        .info-form input[readonly] {
            background-color: #f7f9fc;
            border-color: #dde1e7;
            color: #666;
            cursor: not-allowed;
        }

        .info-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
        }

        .info-actions button {
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-width: 140px;
        }

        #editBtn {
            background: linear-gradient(to right, #3498db, #2980b9);
            color: white;
        }

        #saveBtn {
            background: linear-gradient(to right, #2ecc71, #27ae60);
            color: white;
        }

        #cancelBtn {
            background: linear-gradient(to right, #e74c3c, #c0392b);
            color: white;
        }

        #deleteBtn {
            background: white;
            color: #e74c3c;
            border: 2px solid #e74c3c;
        }

        .info-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        #deleteBtn:hover {
            background: #fff5f5;
        }

        /* CSS TOAST */
        /* ===== TOAST CSS ===== */
        :root {
            --toast-success: #28a745;
            --toast-error: #dc3545;
            --toast-info: #0d6efd;
            --toast-warning: #ffc107;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            min-width: 350px;
            max-width: 450px;
            background: white;
            border-radius: 10px;
            padding: 16px 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transform: translateY(-30px);
            transition: opacity 0.5s ease, transform 0.5s ease;
            overflow: hidden;
            font-family: 'Poppins', sans-serif;
            z-index: 1000;
            border-left: 8px solid var(--toast-color);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            }

            50% {
                box-shadow: 0 15px 45px rgba(var(--toast-shadow-color), 0.5);
            }

            100% {
                box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            }
        }

        .toast--visible {
            opacity: 1;
            transform: translateY(0);
        }

        .toast--success {
            --toast-color: var(--toast-success);
            --toast-shadow-color: 40, 167, 69;
            /* background: linear-gradient(to right, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05), white); */
        }

        .toast--error {
            --toast-color: var(--toast-error);
            --toast-shadow-color: 220, 53, 69;
            /* background: linear-gradient(to right, rgba(220, 53, 69, 0.1), rgba(220, 53, 69, 0.05), white); */
        }

        .toast__icon {
            font-size: 28px;
            margin-right: 16px;
            color: var(--toast-color);
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        .toast__message {
            flex: 1;
            font-size: 16px;
            color: #333;
            line-height: 1.4;
            font-weight: 500;
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.5);
        }

        .toast__close {
            margin-left: 16px;
            font-size: 24px;
            color: #777;
            cursor: pointer;
            transition: all 0.3s;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.05);
        }

        .toast__close:hover {
            color: var(--toast-color);
            background: rgba(0, 0, 0, 0.1);
            transform: rotate(90deg);
        }

        .toast__progress {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 5px;
            background: linear-gradient(to right, var(--toast-color), rgba(var(--toast-shadow-color), 0.6));
            transition: width linear 4s;
            border-radius: 0 2px 2px 0;
        }
    </style>
</head>

<body>
    <div th:if="${toastMessage}" id="toast-message" class="toast"
        th:classappend="${toastType == 'error'} ? 'toast--error' : 'toast--success'">
        <div class="toast__icon">
            <i th:class="${toastType == 'error'} ? 'fas fa-exclamation-circle' : 'fas fa-check-circle'"></i>
        </div>
        <div class="toast__message" th:utext="${toastMessage}">…</div>
        <div class="toast__close" onclick="hideToast(this)">&times;</div>
        <div class="toast__progress"></div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="toggle-btn" id="sidebarToggle">
            <img src="/images/toggle.png" alt="toggle" />
        </div>
        <div class="profile-icon">
            <img src="/images/avt.png" alt="" />
        </div>
        <div id="user-name" class="name" th:text="${username}" style="text-transform: uppercase; font-weight: bold;">
            <h1>User</h1>
        </div>
        <nav class="menu">
            <button class="menu-btn" th:classappend="${currentMenu == 'information'} ? 'active' : ''"
                data-menu="information">
                <img class="menu-icon" src="/images/info.png" alt="information" />
                <p>INFORMATION</p>
            </button>
            <button class="menu-btn" th:classappend="${currentMenu == 'manage_system'} ? 'active' : ''"
                data-menu="manageSystem">
                <img class="menu-icon" src="/images/manage.png" alt="manage" />
                <p>MANAGE SYSTEMS</p>
            </button>
        </nav>
        <div class="settings">
            <div class="gear-icon">
                <img class="setting-icon" src="/images/setting_icon.png" alt="setting" />
                <p>DARK MODE</p>
            </div>
            <div class="power-icon"
                th:onclick="|if(confirm('Do you truly intend to logout?')) { window.location.href='@{/}'; }|">
                <img class="logout-icon" src="/images/logout_icon.png" alt="logout" />
                <p>LOG OUT</p>
            </div>
        </div>
    </div>
    <div class="main-content" id="content-area">
        <div class="success-message" th:if="${message}" th:text="${message}" style="color: green; margin-bottom: 20px;">
        </div> <br>
        <div th:fragment="section(menuOption)" th:remove="tag">
            <div th:switch="${menuOption}">

                <div th:case="'information'" id="information-section">
                    <h1 class="section-title">User Infomation</h1>
                    <div class="info-container">
                        <div class="info-content">
                            <p><strong>Full Name:</strong> <span th:text="${userInfo.fullname}">N/A</span></p>
                            <p><strong>Username:</strong> <span th:text="${userInfo.username}">N/A</span></p>
                            <p><strong>Email:</strong> <span th:text="${userInfo.email}">N/A</span></p>
                        </div>
                    </div>

                    <h1 class="section-title">Edit your Infomation</h1>
                    <form th:action="@{'/home_' + ${userInfo.username} + '/information'}" method="post">
                        <div class="info-form">
                            <p>
                                <strong>Full Name:</strong>
                                <input type="text" th:value="${userInfo.fullname}" name="fullname" disabled />
                            </p>
                            <p>
                                <strong>Username:</strong>
                                <input type="text" th:value="${userInfo.username}" name="username" readonly />
                            </p>
                            <p>
                                <strong>Email:</strong>
                                <input type="email" th:value="${userInfo.email}" name="email" disabled />
                            </p>
                            <p>
                                <strong>Password:</strong>
                                <input type="password" th:value="${userInfo.password}" name="password" disabled />
                            </p>
                        </div>
                        <div class="info-actions">
                            <button type="button" id="editBtn" onclick="enableEditing()">Edit</button>
                            <button type="submit" id="saveBtn" style="display:none;">Save</button>
                            <button type="button" id="cancelBtn" style="display:none;"
                                onclick="disableEditing()">Cancel</button>
                            <button type="button" id="deleteBtn" onclick="confirmDelete()">Delete Account</button>
                        </div>
                    </form>

                </div>

                <div th:case="*" class="section">
                    <div th:each="computer : ${computers}" class="computer" th:data-pcname="${computer.pcName}">
                        <a th:href="@{'/delete-pc/' + ${username} + '/' + ${computer.pcName}}"
                            onclick="event.stopPropagation(); return confirm('Are you sure you want to delete this PC?')"
                            class="delete-btn">
                            <i class="fas fa-times"></i>
                        </a>
                        <img src="/images/computer.png" alt="Computer">
                        <div class="pc-name" th:text="${computer.pcName}">PC NAME</div>
                        <div class="status">
                            <div class="status-item ssh-status" th:classappend="${computer.sshStatus} ? 'connected'"
                                th:style="${!computer.sshStatus} ? 'color: #e74c3c;' : ''">
                                <span th:text="${computer.sshStatus} ? 'SSH: Connected' : 'SSH: Disconnected'">SSH:
                                    Disconnected</span>
                            </div>
                            <div class="status-item active"
                                th:style="${computer.ufwStatus} ? 'color: #27ae60;' : 'color: #e74c3c;'">
                                <span th:text="${computer.ufwStatus} ? 'UFW Status: ON' : 'UFW Status: OFF'">UFW Status:
                                    Unknown</span>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button type="button" class="details-btn" th:data-pcname="${computer.pcName}"
                                onclick="openDetailModal(event, this)">
                                <i class="fas fa-info-circle"></i>
                            </button>
                            <button class="check-status-btn" th:data-pcname="${computer.pcName}"
                                onclick="checkSSHStatusOne(event, this)">
                                <i class="fa-solid fa-rotate" style="color: #ffffff;"></i>
                            </button>
                            <button class="shutdown-btn" th:data-pcname="${computer.pcName}"
                                onclick="shutdownPC(event, this)">
                                <i class="fas fa-power-off"></i>
                            </button>
                        </div>
                    </div>

                    <div class="add-computer" onclick="openModal()">
                        <img src="/images/add_icon.png" alt="add_icon" />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for adding a computer -->
    <div id="computerModal" class="modal">
        <div class="modal-content">
            <div class="modal-left">
                <!-- <div th:if="${error}" th:text="${error}" style="color: red; margin-bottom: 20px;"></div> -->
                <form th:action="@{/home_{username}(username=${username})}" method="post">
                    <div class="input-contain">
                        <input type="text" class="input-field" name="pcName" required>
                        <label for="pcName">Computer Name</label>
                    </div>
                    <div class="input-contain">
                        <input type="text" class="input-field" name="pcUsername" required>
                        <label for="pcUsername">Ubuntu Username</label>
                    </div>
                    <div class="input-contain">
                        <input type="text" class="input-field" name="ipAddress" required>
                        <label for="ipAddress">IP Address</label>
                    </div>
                    <div class="input-contain">
                        <input type="number" class="input-field" name="port" min="0" required>
                        <label for="port">Port</label>
                    </div>
                    <div class="input-contain">
                        <input type="password" class="input-field" name="password" required>
                        <label for="password">Password</label>
                        <span class="eye-icon" onclick="togglePassword()"><i class="fas fa-eye"></i></span>
                    </div>
                    <button type="submit" class="btn_add_computer">Done</button>
                </form>
            </div>
            <div class="modal-right">
                <h2>ADD <br> YOUR COMPUTER</h2>
                <img src="/images/close.png" alt="Close" onclick="closeModal()">
            </div>
        </div>
    </div>

    <div id="machineDetailModal" class="detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Machine Details: <span id="detail_pcName"></span></h3>
                <span class="off" onclick="closeDetailModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="detail-item">
                    <img src="/images/computer.png" alt="">
                </div>
                <table>
                    <tr>
                        <td><strong>IP Address</strong></td>
                        <td id="detail_ipAddress"></td>
                    </tr>
                    <tr>
                        <td><strong>Port</strong></td>
                        <td id="detail_port"></td>
                    </tr>
                    <tr>
                        <td><strong>Ubuntu Username</strong></td>
                        <td id="detail_pcUsername"></td>
                    </tr>
                    <tr>
                        <td><strong>SSH Status</strong></td>
                        <td id="detail_sshStatus"></td>
                    </tr>
                    <tr>
                        <td><strong>UFW Status</strong></td>
                        <td id="detail_ufwStatus"></td>
                    </tr>
                </table>
                <div class="modal-footer">
                    <button class="close-detail-modal" onclick="closeDetailModal()">
                        Close
                    </button>

                </div>
            </div>
        </div>

        <script>
            const menuButtons = document.querySelectorAll('.menu-btn');
            const contentArea = document.getElementById('content-area');
            let activeButton = document.querySelector('.menu-btn.active');
            const username = document.getElementById('user-name').textContent.trim();

            function openModal() {
                document.getElementById("computerModal").style.display = "flex";
            }

            function closeModal() {
                document.getElementById("computerModal").style.display = "none";
            }

            function redirectToMachine(element) {
                let pcName = element.getAttribute("data-pcname") || 'defaultPC';
                window.location.href = "/machine/" + encodeURIComponent(pcName) + "/information";
            }

            function togglePassword() {
                const passwordInput = document.querySelector(".input-field[name='password']");
                const eyeIcon = document.querySelector(".eye-icon i");
                if (passwordInput.type === "password") {
                    passwordInput.type = "text";
                    eyeIcon.classList.remove("fa-eye");
                    eyeIcon.classList.add("fa-eye-slash");
                } else {
                    passwordInput.type = "password";
                    eyeIcon.classList.remove("fa-eye-slash");
                    eyeIcon.classList.add("fa-eye");
                }
            }

            document.addEventListener("DOMContentLoaded", function () {
                //TOAST
                document.querySelectorAll(".toast").forEach(toast => {
                    // show
                    toast.classList.add("toast--visible");
                    // start progress bar
                    const bar = toast.querySelector(".toast__progress");
                    setTimeout(() => bar.style.width = '100%', 50);
                    // auto hide sau 4s
                    setTimeout(() => hideToast(null, toast), 4000);
                });

                // Handle input fields
                let inputs = document.querySelectorAll(".input-field");
                inputs.forEach(input => {
                    input.addEventListener("blur", function () {
                        if (this.value.trim() !== "") {
                            this.classList.add("has-content");
                        } else {
                            this.classList.remove("has-content");
                        }
                    });

                    if (input.value.trim() !== "") {
                        input.classList.add("has-content");
                    }
                });

                // Activate the active menu button if it exists
                if (activeButton) {
                    activeButton.click();
                }

                // Restore sidebar state on page load
                const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
                if (isCollapsed) {
                    document.getElementById('sidebar').classList.add('collapsed');
                }

                // Add click handlers for computer divs
                function attachComputerClickHandlers() {
                    const computerDivs = document.querySelectorAll('.computer');
                    computerDivs.forEach(div => {
                        // Remove any existing click listeners to avoid duplicates
                        div.removeEventListener('click', handleComputerClick);
                        div.addEventListener('click', handleComputerClick);
                    });
                }

                function handleComputerClick(e) {
                    const div = e.currentTarget;
                    // Only redirect if not clicking the check-status button or delete button
                    if (!e.target.closest('.check-status-btn') && !e.target.closest('.delete-btn')) {
                        // Only redirect if the div is accessible (SSH connected)
                        if (div.classList.contains('accessible')) {
                            redirectToMachine(div);
                        } else {
                            console.log('Cannot redirect: Machine is not accessible (SSH disconnected or status unknown).');
                        }
                    }
                }

                // Initial attachment of click handlers
                attachComputerClickHandlers();

                // Auto check status for all computers when page loads
                setTimeout(function () {
                    const statusButtons = document.querySelectorAll('.check-status-btn');
                    if (statusButtons.length > 0) {
                        statusButtons.forEach((button, index) => {
                            setTimeout(() => {
                                const mockEvent = {
                                    stopPropagation: function () { },
                                    target: null // Not the button, so won't stop propagation
                                };
                                checkSSHStatusOne(mockEvent, button);
                            }), 200; // Check each computer with a 2-second delay
                        });
                    }
                }), 100; // Wait 1 second after page load before starting checks

                // Re-attach click handlers after content area updates (e.g., after fetch)
                const originalFetch = window.fetch;
                window.fetch = function (...args) {
                    return originalFetch(...args).then(response => {
                        if (args[0].includes('/home_') && args[1]?.headers['X-Requested-With'] === 'XMLHttpRequest') {
                            // After fetching new content, re-attach click handlers
                            setTimeout(attachComputerClickHandlers, 300); // Wait for DOM update
                        }
                        return response;
                    });
                };
            });

            // hide toast (thisBtn optional)
            function hideToast(btn, toastEl) {
                const toast = toastEl || btn.closest(".toast");
                toast.classList.remove("toast--visible");
            }

            // Menu button click handler
            // Menu button click handler
            menuButtons.forEach(button => {
                button.addEventListener('click', function (e) {
                    e.preventDefault();
                    const menuOption = this.getAttribute('data-menu');
                    const pcName = this.getAttribute('data-pcname');
                    const url = `/home_${encodeURIComponent(username)}/${menuOption}`;

                    if (activeButton) {
                        activeButton.classList.remove('active');
                    }
                    this.classList.add('active');
                    activeButton = this;

                    if (contentArea) {
                        contentArea.style.opacity = '0';
                        window.history.pushState({ menu: menuOption, pcName: pcName }, '', url);

                        fetch(url, {
                            headers: { 'X-Requested-With': 'XMLHttpRequest' }
                        })
                            .then(response => {
                                if (!response.ok)
                                    throw new Error('Network response was not ok: ' + response.statusText);
                                return response.text();
                            })
                            .then(html => {
                                setTimeout(() => {
                                    contentArea.innerHTML = html;
                                    contentArea.style.opacity = '1';

                                    // Check status for all computers if manageSystem section is loaded
                                    if (menuOption === 'manageSystem') {
                                        const statusButtons = document.querySelectorAll('.check-status-btn');
                                        if (statusButtons.length > 0) {
                                            statusButtons.forEach((button, index) => {
                                                setTimeout(() => {
                                                    const mockEvent = {
                                                        stopPropagation: () => { },
                                                        target: null
                                                    };
                                                    checkSSHStatusOne(mockEvent, button);
                                                }); // Check each computer with a 2-second delay
                                            });
                                        }
                                    }
                                });
                            })
                            .catch(error => {
                                console.error('Fetch error:', error);
                                contentArea.innerHTML = '<div class="error-message">Error loading content: ' + error.message + '</div>';
                                contentArea.style.opacity = '1';
                            });
                    } else {
                        console.error('Content area not found!');
                    }
                });
            });

            // Browser back/forward button handler
            window.addEventListener('popstate', function (event) {
                const state = event.state;
                if (state) {
                    const menuOption = state.menu || 'information';
                    const url = `/home_${encodeURIComponent(username)}/${menuOption}`;

                    if (contentArea) {
                        contentArea.style.opacity = '0';
                        fetch(url, {
                            headers: { 'X-Requested-With': 'XMLHttpRequest' }
                        })
                            .then(response => {
                                if (!response.ok)
                                    throw new Error('Network response was not ok: ' + response.statusText);
                                return response.text();
                            })
                            .then(html => {
                                contentArea.innerHTML = html;
                                contentArea.style.opacity = '1';

                                menuButtons.forEach(btn => {
                                    btn.classList.remove('active');
                                    if (btn.getAttribute('data-menu') === menuOption &&
                                        btn.getAttribute('data-pcname') === state.pcName) {
                                        btn.classList.add('active');
                                        activeButton = btn;
                                    }
                                });
                            })
                            .catch(error => {
                                console.error('Popstate fetch error:', error);
                                contentArea.innerHTML = '<div class="error-message">Error loading content: ' + error.message + '</div>';
                                contentArea.style.opacity = '1';
                            });
                    } else {
                        console.error('Content area not found!');
                    }
                }
            });

            // User info editing functions
            function enableEditing() {
                document.querySelectorAll("#information-section input").forEach(function (input) {
                    if (!input.readOnly) {
                        input.disabled = false;
                    }
                });

                document.getElementById("editBtn").style.display = "none";
                document.getElementById("saveBtn").style.display = "inline-block";
                document.getElementById("cancelBtn").style.display = "inline-block";
            }

            function disableEditing() {
                document.querySelectorAll("#information-section input").forEach(function (input) {
                    if (!input.readOnly) {
                        input.disabled = true;
                    }
                });

                document.getElementById("editBtn").style.display = "inline-block";
                document.getElementById("saveBtn").style.display = "none";
                document.getElementById("cancelBtn").style.display = "none";
            }


            function confirmDelete() {
                if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                    const username = document.getElementById('user-name').textContent.trim();
                    window.location.href = `/delete-account/${username}`;
                }
            }

            // Sidebar toggle functionality
            document.getElementById('sidebarToggle').addEventListener('click', function () {
                // Check if modal is open
                const computerModal = document.getElementById("computerModal");
                if (computerModal && window.getComputedStyle(computerModal).display === "flex") {
                    return; // Exit if modal is open
                }

                const sidebar = document.getElementById('sidebar');
                sidebar.classList.toggle('collapsed');

                // Save state to localStorage
                localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
            });

            function checkSSHStatusOne(event, button) {
                if (event.target === button) {
                    event.stopPropagation(); // Prevent click on machine only for direct button clicks
                }

                const pcName = button.getAttribute("data-pcname");
                const pcDiv = document.querySelector(`.computer[data-pcname="${CSS.escape(pcName)}"]`);
                const sshStatusItem = pcDiv.querySelector(".ssh-status");
                const sshStatusSpan = sshStatusItem.querySelector("span");
                const ufwStatusItem = pcDiv.querySelector(".status-item.active");
                const ufwStatusSpan = ufwStatusItem.querySelector("span");

                // Change button text to indicate loading
                const originalButtonText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                button.disabled = true;

                // Show checking status and disable clicks
                sshStatusSpan.textContent = "SSH: Checking...";
                sshStatusItem.classList.remove("connected");
                sshStatusItem.style.color = "#2980b9";
                ufwStatusSpan.textContent = "UFW Status: Checking...";
                ufwStatusItem.style.color = "#2980b9";
                pcDiv.classList.add("checking"); // Disable clicks during check

                // First check SSH status
                fetch(`/api/ssh-status/${username}/${encodeURIComponent(pcName)}`)
                    .then(res => {
                        if (!res.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return res.json();
                    })
                    .then(pc => {
                        if (pc.sshStatus) {
                            sshStatusSpan.textContent = "SSH: Connected";
                            sshStatusItem.classList.add("connected");
                            sshStatusItem.style.color = "";
                            pcDiv.classList.add("accessible"); // Mark as clickable
                            // Now check UFW status since SSH is connected
                            return fetch(`/api/ufw-status/${username}/${encodeURIComponent(pcName)}`);
                        } else {
                            sshStatusSpan.textContent = "SSH: Disconnected";
                            sshStatusItem.classList.remove("connected");
                            sshStatusItem.style.color = "#e74c3c";
                            ufwStatusSpan.textContent = "UFW Status: UNKNOWN";
                            ufwStatusItem.style.color = "#777";
                            pcDiv.classList.remove("accessible"); // Not clickable
                            throw new Error('SSH disconnected');
                        }
                    })
                    .then(res => {
                        if (!res.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return res.json();
                    })
                    .then(data => {
                        // Update UFW status
                        if (data.success) {
                            ufwStatusSpan.textContent = `UFW Status: ${data.status}`;
                            if (data.ufwActive) {
                                ufwStatusItem.style.color = "#27ae60"; // Green for ON
                            } else {
                                ufwStatusItem.style.color = "#e74c3c"; // Red for OFF
                            }
                        } else {
                            ufwStatusSpan.textContent = "UFW Status: ERROR";
                            ufwStatusItem.style.color = "#e74c3c";
                            console.error("UFW status check failed:", data.message);
                        }
                    })
                    .catch(err => {
                        if (err.message !== 'SSH disconnected') {
                            console.error("Status check failed:", err);
                            sshStatusSpan.textContent = "SSH: Error";
                            sshStatusItem.style.color = "#e74c3c";
                            ufwStatusSpan.textContent = "UFW Status: ERROR";
                            ufwStatusItem.style.color = "#e74c3c";
                            pcDiv.classList.remove("accessible"); // Not clickable
                        }
                    })
                    .finally(() => {
                        // Restore button text and re-enable clicks
                        button.innerHTML = originalButtonText;
                        button.disabled = false;
                        pcDiv.classList.remove("checking");
                    });
            }

            function shutdownPC(event, button) {
                // NGĂN CHẶN redirect từ click container
                event.stopPropagation();
                event.preventDefault();

                const pcName = button.getAttribute('data-pcname');
                const username = document.querySelector('meta[name="username"]').getAttribute('content');

                if (!confirm(`Are you sure you want to shutdown "${pcName}"?`)) return;

                showToast('info', 'Sending shutdown command...', 3000);

                fetch(`/api/shutdown/${username}/${encodeURIComponent(pcName)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            showToast('success', 'Shutdown command sent successfully!', 5000);
                            setTimeout(() => {
                                // tìm nút check-status tương ứng trong cùng 1 .computer
                                const statusBtn = button
                                    .closest('.computer')
                                    .querySelector('.check-status-btn');
                                if (statusBtn) {
                                    // fake event để không redirect container
                                    checkSSHStatusOne({ stopPropagation: () => { } }, statusBtn);
                                }
                            }, 1000);

                        } else {
                            showToast('error', `Error: ${data.message}`, 5000);
                        }
                    })
                    .catch(err => {
                        console.error('shutdownPC error:', err);
                        showToast('error', 'Error sending shutdown command', 5000);
                    });
            }

            function openDetailModal(e, btn) {
                e.stopPropagation();
                const pcName = btn.getAttribute('data-pcname');
                const username = document.querySelector("meta[name='username']").getAttribute('content');
                // clear trước
                ["pcName", "ipAddress", "port", "pcUsername", "sshStatus", "ufwStatus"]
                    .forEach(id => document.getElementById("detail_" + id).textContent = "...");

                // fetch chi tiết
                fetch(`/api/pc-detail/${username}/${encodeURIComponent(pcName)}`)
                    .then(r => {
                        if (!r.ok) throw new Error(r.statusText);
                        return r.json();
                    })
                    .then(data => {
                        document.getElementById("detail_pcName").textContent = data.pcName;
                        document.getElementById("detail_ipAddress").textContent = data.ipAddress;
                        document.getElementById("detail_port").textContent = data.port;
                        document.getElementById("detail_pcUsername").textContent = data.pcUsername;
                        document.getElementById("detail_sshStatus").textContent = data.sshStatus ? "Connected" : "Disconnected";
                        document.getElementById("detail_ufwStatus").textContent = data.ufwStatus;
                        // update nút shutdownBtn data-pcname để dùng chung
                        // const sd = document.getElementById("detail_shutdownBtn");
                        // sd.setAttribute("data-pcname", data.pcName);
                        // show modal
                        document.getElementById("machineDetailModal").style.display = "flex";
                    })
                    .catch(err => {
                        console.error("Lấy chi tiết thất bại:", err);
                        alert("Không thể load chi tiết máy.");
                    });
            }

            function closeDetailModal() {
                document.getElementById("machineDetailModal").style.display = "none";
            }

            function showToast(type, message, duration = 3000) {
                const toast = document.createElement('div');
                toast.className = `toast toast--visible toast--${type}`;
                toast.innerHTML = `
      <div class="toast__icon">
        <i class="${type === 'error'
                        ? 'fas fa-exclamation-circle'
                        : (type === 'success'
                            ? 'fas fa-check-circle'
                            : 'fas fa-info-circle')}"></i>
      </div>
      <div class="toast__message">${message}</div>
      <div class="toast__close" onclick="hideToast(this)">&times;</div>
      <div class="toast__progress"></div>
    `;
                document.body.appendChild(toast);
                setTimeout(() => {
                    const bar = toast.querySelector('.toast__progress');
                    if (bar) bar.style.width = '100%';
                }, 50);
                setTimeout(() => hideToast(null, toast), duration + 200);
            }

            function hideToast(btn, toastEl) {
                const toast = toastEl || btn.closest(".toast");
                toast.classList.remove("toast--visible");
                // optional: xóa DOM sau animation
                setTimeout(() => toast.remove(), 500);
            }


        </script>
</body>

</html>